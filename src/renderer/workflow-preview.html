<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Workflow Preview</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      overflow: hidden;
      background: transparent;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      user-select: none;
      -webkit-app-region: no-drag;
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
    }

    /* Control bar at top */
    #control-bar {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 15, 20, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      z-index: 10000;
      pointer-events: auto;
      color: #e4e4e7;
      font-size: 13px;
    }

    #control-bar .title {
      font-weight: 600;
      color: #22d3ee;
    }

    #control-bar .count {
      color: #a1a1aa;
    }

    #control-bar .close-btn {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #fca5a5;
      padding: 4px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.15s;
    }

    #control-bar .close-btn:hover {
      background: rgba(239, 68, 68, 0.4);
      color: #fff;
    }

    #control-bar .toggle-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #d4d4d8;
      padding: 4px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.15s;
    }

    #control-bar .toggle-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
    }

    #control-bar .toggle-btn.active {
      background: rgba(6, 182, 212, 0.2);
      border-color: rgba(6, 182, 212, 0.4);
      color: #22d3ee;
    }

    /* Target markers */
    .target-point {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    .target-point::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    .target-point.move {
      border: 2px solid rgba(34, 211, 238, 0.9);
      background: rgba(34, 211, 238, 0.15);
    }
    .target-point.move::before {
      background: rgba(34, 211, 238, 1);
    }

    .target-point.click {
      border: 2px solid rgba(96, 165, 250, 0.9);
      background: rgba(96, 165, 250, 0.15);
    }
    .target-point.click::before {
      background: rgba(96, 165, 250, 1);
    }

    /* Crosshair lines */
    .target-point .crosshair-h,
    .target-point .crosshair-v {
      position: absolute;
      background: currentColor;
      opacity: 0.3;
    }
    .target-point .crosshair-h {
      width: 24px;
      height: 1px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .target-point .crosshair-v {
      width: 1px;
      height: 24px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .target-point.move { color: rgba(34, 211, 238, 1); }
    .target-point.click { color: rgba(96, 165, 250, 1); }

    /* Bounding box */
    .target-bounds {
      position: absolute;
      border: 2px dashed rgba(34, 211, 238, 0.7);
      background: rgba(34, 211, 238, 0.06);
      border-radius: 3px;
    }

    /* Labels */
    .target-label {
      position: absolute;
      background: rgba(15, 15, 20, 0.85);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      pointer-events: none;
    }

    .target-label .step-num {
      color: #a1a1aa;
      margin-right: 4px;
    }

    .target-label .step-name {
      color: #e4e4e7;
    }

    .target-label.move {
      border-color: rgba(34, 211, 238, 0.4);
    }
    .target-label.move .step-num {
      color: #22d3ee;
    }

    .target-label.click {
      border-color: rgba(96, 165, 250, 0.4);
    }
    .target-label.click .step-num {
      color: #60a5fa;
    }

    .target-label.bounds {
      border-color: rgba(34, 211, 238, 0.4);
    }
    .target-label.bounds .step-num {
      color: #22d3ee;
    }

    /* Connection lines between sequential points */
    .connection-line {
      position: absolute;
      pointer-events: none;
      opacity: 0.2;
    }

    /* Pulse animation for points */
    .target-point::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: pulse 2s ease-in-out infinite;
    }

    .target-point.move::after {
      border: 1px solid rgba(34, 211, 238, 0.5);
    }
    .target-point.click::after {
      border: 1px solid rgba(96, 165, 250, 0.5);
    }

    @keyframes pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
    }

    /* Legend */
    #legend {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 15, 20, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      padding: 6px 14px;
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 11px;
      color: #a1a1aa;
      pointer-events: auto;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid;
    }

    .legend-dot.move {
      border-color: #22d3ee;
      background: rgba(34, 211, 238, 0.2);
    }

    .legend-dot.click {
      border-color: #60a5fa;
      background: rgba(96, 165, 250, 0.2);
    }

    .legend-box {
      width: 14px;
      height: 10px;
      border: 2px dashed #22d3ee;
      background: rgba(34, 211, 238, 0.1);
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div id="overlay"></div>

  <div id="control-bar">
    <span class="title">Workflow Preview</span>
    <span class="count" id="target-count"></span>
    <button class="toggle-btn active" id="btn-labels">Labels</button>
    <button class="toggle-btn active" id="btn-lines">Lines</button>
    <button class="close-btn" id="btn-close">Close (ESC)</button>
  </div>

  <div id="legend">
    <div class="legend-item"><span class="legend-dot move"></span> Mouse Move</div>
    <div class="legend-item"><span class="legend-dot click"></span> Mouse Click</div>
    <div class="legend-item"><span class="legend-box"></span> Bounding Box</div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    
    const overlay = document.getElementById('overlay');
    let targets = [];
    let offset = { x: 0, y: 0 };
    let showLabels = true;
    let showLines = true;

    ipcRenderer.on('workflow-preview:init', (event, data) => {
      targets = data.targets;
      offset = data.offset;
      document.getElementById('target-count').textContent = `${targets.length} targets`;
      render();
    });

    function render() {
      overlay.innerHTML = '';

      // Draw connection lines first (behind everything)
      if (showLines) {
        const points = targets.filter(t => t.type === 'point' || t.type === 'click');
        for (let i = 1; i < points.length; i++) {
          const from = points[i - 1];
          const to = points[i];
          drawLine(from, to);
        }
      }

      // Draw targets
      targets.forEach(target => {
        if (target.type === 'bounds') {
          drawBounds(target);
        } else {
          drawPoint(target);
        }
      });
    }

    function drawPoint(target) {
      const x = target.x - offset.x;
      const y = target.y - offset.y;
      const cls = target.actionType === 'mouse_click' ? 'click' : 'move';

      const el = document.createElement('div');
      el.className = `target-point ${cls}`;
      el.style.left = `${x}px`;
      el.style.top = `${y}px`;
      el.innerHTML = '<div class="crosshair-h"></div><div class="crosshair-v"></div>';
      overlay.appendChild(el);

      if (showLabels) {
        const label = document.createElement('div');
        label.className = `target-label ${cls}`;
        const nameStr = target.label ? ` <span class="step-name">${target.label}</span>` : '';
        const typeStr = target.actionType === 'mouse_click' 
          ? `Click${target.button !== 'left' ? ` (${target.button})` : ''}${target.clickType === 'double' ? ' x2' : ''}`
          : 'Move';
        label.innerHTML = `<span class="step-num">#${target.step}</span>${nameStr || `<span class="step-name">${typeStr} (${target.x}, ${target.y})</span>`}`;
        label.style.left = `${x + 12}px`;
        label.style.top = `${y - 20}px`;
        overlay.appendChild(label);
      }
    }

    function drawBounds(target) {
      const x = target.x - offset.x;
      const y = target.y - offset.y;

      const el = document.createElement('div');
      el.className = 'target-bounds';
      el.style.left = `${x}px`;
      el.style.top = `${y}px`;
      el.style.width = `${target.width}px`;
      el.style.height = `${target.height}px`;
      overlay.appendChild(el);

      if (showLabels) {
        const label = document.createElement('div');
        label.className = 'target-label bounds';
        const nameStr = target.label ? ` <span class="step-name">${target.label}</span>` : '';
        label.innerHTML = `<span class="step-num">#${target.step}</span>${nameStr || `<span class="step-name">Move (${target.width}Ã—${target.height})</span>`}`;
        label.style.left = `${x}px`;
        label.style.top = `${y - 22}px`;
        overlay.appendChild(label);
      }
    }

    function drawLine(from, to) {
      const x1 = from.x - offset.x;
      const y1 = from.y - offset.y;
      const x2 = to.x - offset.x;
      const y2 = to.y - offset.y;

      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.style.position = 'absolute';
      svg.style.left = '0';
      svg.style.top = '0';
      svg.style.width = '100%';
      svg.style.height = '100%';
      svg.style.pointerEvents = 'none';
      svg.style.opacity = '0.25';

      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', x1);
      line.setAttribute('y1', y1);
      line.setAttribute('x2', x2);
      line.setAttribute('y2', y2);
      line.setAttribute('stroke', '#a1a1aa');
      line.setAttribute('stroke-width', '1');
      line.setAttribute('stroke-dasharray', '4,4');

      svg.appendChild(line);
      overlay.appendChild(svg);
    }

    // Toggle buttons
    document.getElementById('btn-labels').addEventListener('click', () => {
      showLabels = !showLabels;
      document.getElementById('btn-labels').classList.toggle('active', showLabels);
      render();
    });

    document.getElementById('btn-lines').addEventListener('click', () => {
      showLines = !showLines;
      document.getElementById('btn-lines').classList.toggle('active', showLines);
      render();
    });

    // Close button
    document.getElementById('btn-close').addEventListener('click', () => {
      ipcRenderer.send('workflow-preview:close');
    });

    // ESC to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        ipcRenderer.send('workflow-preview:close');
      }
    });
  </script>
</body>
</html>
